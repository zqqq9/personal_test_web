<!DOCTYPE html>
<html>
<head>
  <title>应用程序状态检查</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
      color: #333;
      line-height: 1.5;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 20px;
    }
    h1 {
      margin-top: 0;
      color: #2563eb;
    }
    .check-item {
      margin-bottom: 15px;
      padding: 15px;
      border-radius: 5px;
      background: #f5f7ff;
    }
    .check-title {
      font-weight: bold;
      margin-bottom: 5px;
    }
    .asset-list {
      font-family: monospace;
      background: #f0f0f0;
      padding: 10px;
      border-radius: 4px;
      margin-top: 10px;
      overflow-x: auto;
      max-height: 200px;
      overflow-y: auto;
    }
    .success {
      color: #16a34a;
    }
    .error {
      color: #dc2626;
    }
    .warning {
      color: #ca8a04;
    }
    .button {
      background: #2563eb;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 10px;
      margin-top: 10px;
    }
    .button:hover {
      background: #1d4ed8;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>应用程序状态检查</h1>
    <p>本页面用于检查应用程序的加载状态和资源可用性，以帮助诊断部署问题。</p>
    
    <div id="results">
      <div class="check-item">
        <div class="check-title">正在加载检查结果...</div>
      </div>
    </div>
    
    <button class="button" id="run-checks">重新运行检查</button>
    <button class="button" onclick="window.location.href='/'">返回主页</button>
  </div>
  
  <script>
    function appendResult(title, message, status) {
      const results = document.getElementById('results');
      const item = document.createElement('div');
      item.className = 'check-item';
      
      const titleEl = document.createElement('div');
      titleEl.className = 'check-title';
      titleEl.textContent = title;
      
      const messageEl = document.createElement('div');
      messageEl.className = status || '';
      messageEl.innerHTML = message;
      
      item.appendChild(titleEl);
      item.appendChild(messageEl);
      results.appendChild(item);
      
      return item;
    }
    
    function checkResource(url, description) {
      return fetch(url, { method: 'HEAD' })
        .then(response => {
          if (response.ok) {
            appendResult(
              `${description} 可用性`,
              `✅ ${url} 可以访问 (HTTP ${response.status})`,
              'success'
            );
            return { success: true, url, status: response.status };
          } else {
            appendResult(
              `${description} 可用性`,
              `❌ ${url} 无法访问 (HTTP ${response.status})`,
              'error'
            );
            return { success: false, url, status: response.status };
          }
        })
        .catch(error => {
          appendResult(
            `${description} 可用性`,
            `❌ ${url} 无法访问: ${error.message}`,
            'error'
          );
          return { success: false, url, error: error.message };
        });
    }
    
    function scanAssets() {
      return fetch('/assets/')
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }
          return response.text();
        })
        .then(html => {
          const assetItem = appendResult(
            'Assets 目录内容',
            '正在解析资源...',
            ''
          );
          
          // 分析 HTML 查找链接
          const links = html.match(/href="([^"]+)"/g) || [];
          const assetLinks = links
            .map(link => link.match(/href="([^"]+)"/)[1])
            .filter(href => href.includes('/assets/') || !href.startsWith('/'));
          
          if (assetLinks.length > 0) {
            const assetList = document.createElement('div');
            assetList.className = 'asset-list';
            
            assetLinks.forEach(asset => {
              const assetEl = document.createElement('div');
              assetEl.textContent = asset;
              assetList.appendChild(assetEl);
            });
            
            assetItem.innerHTML = `✅ 找到 ${assetLinks.length} 个资源文件`;
            assetItem.className = 'check-item success';
            assetItem.appendChild(assetList);
            
            // 检查 JS 和 CSS 文件
            const jsFiles = assetLinks.filter(a => a.endsWith('.js'));
            const cssFiles = assetLinks.filter(a => a.endsWith('.css'));
            
            appendResult(
              'JavaScript 文件',
              jsFiles.length > 0 
                ? `✅ 找到 ${jsFiles.length} 个 JS 文件: ${jsFiles.join(', ')}` 
                : '❌ 未找到 JS 文件',
              jsFiles.length > 0 ? 'success' : 'error'
            );
            
            appendResult(
              'CSS 文件',
              cssFiles.length > 0 
                ? `✅ 找到 ${cssFiles.length} 个 CSS 文件: ${cssFiles.join(', ')}` 
                : '❌ 未找到 CSS 文件',
              cssFiles.length > 0 ? 'success' : 'error'
            );
          } else {
            assetItem.innerHTML = '❌ 未找到资源文件';
            assetItem.className = 'check-item error';
          }
          
          return assetLinks;
        })
        .catch(error => {
          appendResult(
            'Assets 目录',
            `❌ 无法访问资源目录: ${error.message}`,
            'error'
          );
          return [];
        });
    }
    
    function runTests() {
      document.getElementById('results').innerHTML = '';
      
      // 检查基础文件
      appendResult('运行环境', `当前页面 URL: ${window.location.href}`, '');
      appendResult('浏览器信息', `${navigator.userAgent}`, '');
      
      Promise.all([
        checkResource('/', '主页'),
        checkResource('/index.html', 'index.html'),
        checkResource('/_redirects', '_redirects 文件'),
        checkResource('/netlify.toml', 'netlify.toml 文件'),
        checkResource('/_headers', '_headers 文件'),
        checkResource('/loader.js', 'loader.js 文件')
      ])
      .then(() => scanAssets())
      .then(assets => {
        // 检查典型的 JS 和 CSS 文件
        const jsFile = assets.find(a => a.match(/index-.*\.js$/));
        const cssFile = assets.find(a => a.match(/index-.*\.css$/));
        
        if (jsFile) {
          return fetch(jsFile)
            .then(response => response.text())
            .then(content => {
              const item = appendResult(
                'JavaScript MIME 类型检查',
                '检查响应头中的 Content-Type...',
                ''
              );
              
              fetch(jsFile)
                .then(response => {
                  const contentType = response.headers.get('content-type');
                  if (contentType && contentType.includes('javascript')) {
                    item.innerHTML = `✅ ${jsFile} 的 MIME 类型正确: ${contentType}`;
                    item.className = 'check-item success';
                  } else {
                    item.innerHTML = `❌ ${jsFile} 的 MIME 类型错误: ${contentType || '未设置'}`;
                    item.className = 'check-item error';
                  }
                })
                .catch(error => {
                  item.innerHTML = `❌ 检查 MIME 类型时出错: ${error.message}`;
                  item.className = 'check-item error';
                });
            });
        }
      });
    }
    
    document.getElementById('run-checks').addEventListener('click', runTests);
    
    // 自动运行
    runTests();
  </script>
</body>
</html> 